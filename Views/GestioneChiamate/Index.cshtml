@model WebApplicationCentralino.Models.Chiamata
@{
    ViewData["Title"] = "Elenco Chiamate";    
    var chiamate = ViewBag.Chiamate as List<WebApplicationCentralino.Models.Chiamata>;

}


<h2>@ViewData["Title"]</h2>

<div class="alert alert-info">
    Inserire almeno uno tra Numero e Ragione Sociale sia per il chiamante che per il chiamato.
</div>

<form asp-action="Salva" method="post" id="formChiamata">
    
@if (Model.Id > 0)
{        
    <input type = "hidden" asp-for = "Id" />
}

<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="NumeroChiamante" class="form-label">Numero Chiamante</label>
            <input asp-for="NumeroChiamante" class="form-control" />
            <span asp-validation-for="NumeroChiamante" class="text-danger"></span>
        </div>
    </div>
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="RagioneSocialeChiamante" class="form-label">Ragione Sociale Chiamante</label>
            <input asp-for="RagioneSocialeChiamante" class="form-control" />
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="NumeroChiamato" class="form-label">Numero Chiamato</label>
            <input asp-for="NumeroChiamato" class="form-control" />
            <span asp-validation-for="NumeroChiamato" class="text-danger"></span>
        </div>
    </div>
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="RagioneSocialeChiamato" class="form-label">Ragione Sociale Chiamato</label>
            <input asp-for="RagioneSocialeChiamato" class="form-control" />
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="DataArrivoChiamata" class="form-label">Data Arrivo</label>
            <input asp-for="DataArrivoChiamata" class="form-control" type="datetime-local" step="1" />
        </div>
    </div>
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="DataFineChiamata" class="form-label">Data Fine</label>
            <input asp-for="DataFineChiamata" class="form-control" type="datetime-local" step="1" />
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="TipoChiamata" class="form-label">Tipo</label>
                <select asp-for="TipoChiamata" class="form-select">
                    <option value="Entrata">Entrata</option>
                    <option value="Uscita">Uscita</option>
                </select>
            <!-- Campo nascosto per mantenere il valore numerico -->
            @* <input type="hidden" id="TipoChiamataValue" name="TipoChiamataValue" /> *@
        </div>
    </div>
    <div class="col-md-6">
        <div class="mb-3">
            <label asp-for="Locazione" class="form-label">Locazione</label>
            <input asp-for="Locazione" class="form-control" />
        </div>
    </div>
</div>
<input type="hidden" asp-for="UniqueID" value="@(Model.UniqueID ?? Guid.NewGuid().ToString())" />

<button type="submit" class="btn btn-success">Salva</button>
<a asp-controller="Chiamate" asp-action="Index" class="btn btn-secondary">Annulla</a>

    
@if (!ViewData.ModelState.IsValid)
{        
    <div class = "alert alert-danger mt-3">
        <div asp-validation-summary = "All" class = "text-danger"></div>
    </div>  
}

</form>

@section Scripts {
    <script>
        @if (!string.IsNullOrEmpty(TempData["msg"] as string))
        {
            @Html.Raw(TempData["msg"])
        }

        function editCall(id, numChiamante, numChiamato, ragSocChiamante, ragSocChiamato,
                        dataArrivo, dataFine, tipo, locazione, uniqueID) {
            document.getElementById("Id").value = id;
            document.getElementById("NumeroChiamante").value = numChiamante;
            document.getElementById("NumeroChiamato").value = numChiamato;
            document.getElementById("RagioneSocialeChiamante").value = ragSocChiamante;
            document.getElementById("RagioneSocialeChiamato").value = ragSocChiamato;
            document.getElementById("DataArrivoChiamata").value = dataArrivo;
            document.getElementById("DataFineChiamata").value = dataFine;
            document.getElementById("TipoChiamata").value = tipo;
            document.getElementById("Locazione").value = locazione;
            document.getElementById("UniqueID").value = uniqueID;

            // Scorri alla sezione del form
            document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById("btnAnnulla").addEventListener("click", function(e) {
            // Preveniamo il comportamento predefinito del link
            e.preventDefault();
            
            // Reimposta l'ID a 0 per indicare una nuova chiamata
            document.getElementById("Id").value = "0";
            // Reimposta i campi del form
            document.getElementById("NumeroChiamante").value = "";
            document.getElementById("NumeroChiamato").value = "";
            document.getElementById("RagioneSocialeChiamante").value = "";
            document.getElementById("RagioneSocialeChiamato").value = "";
            document.getElementById("RagioneSocialeChiamato").value = "";
            // Reimposta anche gli altri campi se necessario
            document.getElementById("DataArrivoChiamata").value = "";
            document.getElementById("DataFineChiamata").value = "";
            document.getElementById("TipoChiamata").value = "Uscita"; // Imposta su "Uscita" di default
            document.getElementById("Locazione").value = "";
            // Genera un nuovo UniqueID
            document.getElementById("UniqueID").value = crypto.randomUUID();
            
            // Scorri alla sezione dell'elenco chiamate
            document.getElementById("sezioneElencoChiamate").scrollIntoView({ behavior: 'smooth' });
        });

        // Aggiunge un event listener al form per impostare il valore numerico del tipo di chiamata prima dell'invio
        // document.getElementById("formChiamata").addEventListener("submit", function() {
        //     Il valore è già numerico (0 o 1) quindi non c'è bisogno di convertire
        //     document.getElementById("TipoChiamataValue").value = document.getElementById("TipoChiamata").value;
        // });
    </script>
}